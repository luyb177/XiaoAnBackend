syntax = "proto3";
import "third_party/google/protobuf/any.proto";
package auth;
option go_package = "./auth/v1";


message User {
  uint64 id = 1;
  string name = 2;
  string email = 3;
  string avatar = 4;
  string phone = 5;
  string password = 6;
  string department = 7;

  string role = 8;           // superadmin / classadmin / student / staff
  uint64 class_id = 9;       // 所属班级 学生 ID
  int64 status = 10;         // 0正常 1禁用 2删除
  string invite_code_used = 11;

  int64 created_at = 12;
  int64 updated_at = 13;
}

message InviteCode {
  string code = 1;
  string creator_id = 2;
  string creator_name = 3;
  string department = 4;

  int64 max_uses = 5;
  int64 used_count = 6;
  int64 is_active = 7;  // 1 有效  0 无效
  string remark = 8;
  int64 created_at = 9;
  int64 expires_at = 10;

  string target_role = 11;    // 邀请码的目标角色 classadmin / student / staff
  uint64 class_id = 12;       // student 用，注册自动加入班级 其中 0 表示没有班级
  string type = 13;           // 记录的邀请码的类型 admin / student / staff
}

message Class {
  uint64 id = 1;                // 班级 ID
  string name = 2;              // 班级名称，如 "软件工程 2201 班"
  string department = 3;        // 所属部门 / 学院
  uint64 admin_id = 4;          // 班级管理员（班主任）
  string admin_name = 5;        // 管理员名称，冗余字段（方便查询）

  uint64 student_count = 6;     // 班级学生数量
  int64 status = 7;             // 状态：0 正常，1 禁用，2 已解散

  int64 created_at = 8;         // 创建时间
  int64 updated_at = 9;         // 更新时间
}


message SendEmailRequest {
  string email = 1;
}

message ValidateEmailRequest {
  string email = 1;
  string code = 2;
}

message GenerateInviteCodeRequest {
  string creator_id = 1;
  string creator_name = 2;
  string department = 3;

  int64 max_uses = 4;
  string remark = 5;
  int64 expires_at = 6;

  string target_role = 7; // 邀请码的目标角色
  uint64 class_id = 8;  // student用，注册时自动加入班级
}

message GenerateInviteCodeResponse {
  string code = 1;
  string creator_id = 2;
  string creator_name = 3;
  string department = 4;
  int64 max_uses = 5;
  string remark = 6;
  int64 created_at = 7;
  int64 expires_at = 8;
  string target_role = 9;
  uint64  class_id = 10;
}

message GetInviteCodeRequest {
  string creator_id = 1;
  int64 page = 2; // 当前页码
  int64 page_size = 3;
}

message GetInviteCodeResponse {
  repeated InviteCode codes = 1;
  int64 total = 2;
  int64 page = 3;
  int64 page_size = 4;
}

message ValidateInviteCodeRequest {
  string code = 1;
}



message LoginRequest {
  string email = 1;
  string password = 2;
}

message LoginResponse {
  string token = 1;
  User user = 2;
}

message RegisterRequest {
  string name = 1;
  string email = 2;
  string avatar = 3;
  string phone = 4;
  string password = 5;
  string department = 6;

  string role = 7;
  string class_id = 8;  // + optional
  string invite_code_used = 9;

  string email_code = 10;
}

message RegisterResponse {
  string id = 1;
  string name = 2;
  string email = 3;
  string avatar = 4;
  string phone = 5;
  string department = 7;

  string role = 8;           // superadmin / classadmin / student / staff
  uint64 class_id = 9;       // 所属班级 学生 ID
  int64 status = 10;         // 0正常 1禁用 2删除
  string invite_code_used = 11;

  int64 created_at = 12;
  int64 updated_at = 13;
}


message Response {
  int64 code = 1;
  string message = 2;
  google.protobuf.Any data = 3;
}

service AuthService {
  // 邮箱验证码
  rpc SendEmailCode(SendEmailRequest) returns (Response);
  rpc ValidateEmailCode(ValidateEmailRequest) returns (Response);

  // 邀请码
  rpc GenerateInviteCode(GenerateInviteCodeRequest) returns (Response);
  rpc ValidateInviteCode(ValidateInviteCodeRequest) returns (Response);
  rpc GetInviteCode(GetInviteCodeRequest) returns (Response);

  // 注册登录
  rpc Register(RegisterRequest) returns (Response);
  rpc Login(LoginRequest) returns (Response);
}
