syntax = "proto3";
import "third_party/google/protobuf/any.proto";
package content;
option go_package = "./content/v1";

message Video {
  uint64 id = 1;
  string name = 2;
  repeated string tag = 3;
  string url = 4;
  string description = 5;
  string cover = 6;
  string author = 7;
  int64 create_time = 8;
  int64 created_at = 9;
  int64 update_time = 10;
  uint64 like_count = 11;
  uint64 view_count = 12;
  uint64 collect_count = 13;
}

message Comic {
  uint64 id = 1;
  string name = 2;
  repeated string tag = 3;
  repeated string url = 4;
  string description = 5;
  string cover = 6;
  string author = 7;
  int64 create_time = 8;
  int64 created_at = 9;
  int64 update_time = 10;
  uint64 like_count = 11;
  uint64 view_count = 12;
  uint64 collect_count = 13;
}

message Podcast {
  uint64 id = 1;
  string name = 2;
  repeated string tag = 3;
  string url = 4;
  string description = 5;
  string cover = 6;
  string author = 7;
  int64 create_time = 8;
  int64 created_at = 9;
  int64 update_time = 10;
  uint64 like_count = 11;
  uint64 view_count = 12;
  uint64 collect_count = 13;
}

message Article {
  uint64 id = 1;
  string name = 2;
  repeated string tag = 3;
  string url = 4;
  string description = 5;
  string cover = 6;
  string content = 7;
  string author = 8;
  int64 create_time = 9;
  int64 created_at = 10;
  int64 update_time = 11;
  uint64 like_count = 12;
  uint64 view_count = 13;
  uint64 collect_count = 14;
}

// 点赞记录
message ContentLike {
  uint64 id = 1;
  string type = 2;  // video,comic,podcast,article,comment
  uint64 target_id = 3;
  uint64 user_id = 4;
  string status = 5; // valid invalid - 有效 无效
  int64 created_at = 6;
  int64 updated_at = 7;
}

// 收藏记录
message ContentCollect {
  uint64 id = 1;
  string type = 2;
  uint64 target_id = 3;
  uint64 user_id = 4;
  string status = 5;
  int64 created_at = 6;
  int64 updated_at = 7;
}

// 评论
message Comment {
  uint64 id = 1;
  string type = 2;
  uint64 target_id = 3;
  uint64 user_id = 4;
  uint64 parent_id = 5; // 为0 则为根评论
  uint64 reply_comment_id = 6;
  uint64 reply_user_id = 7;
  string content = 8;
  uint64 like_count = 9;
  int64 created_at = 10;
  int64 updated_at = 11;
}

// 文件分片请求
message UploadChunk {
  string filename = 1;
  bytes data = 2; // 每个分片的二进制内容
  bool is_last = 3; // 是否最后一片
}

// 响应
message UploadResponse {
  string url = 3;
}


// 获取访问链接请求
message GetContentURLRequest {
  string object_name = 1; // MinIO对象名
}

// 获取访问链接响应
message GetContentURLResponse {
  string url = 1;
  int64 expires_in = 2; // 有效期秒数
}

// 添加视频
message AddVideoRequest {
  string name = 1;
  repeated string tag = 2;
  string url = 3;
  string description = 4;
  string cover = 5;
  string author = 6;
  int64 create_time = 7;
}

message SearchRequest {
  string keyword = 1;        // 搜索关键字
  string type = 2;           // video, comic, podcast, article
  repeated string tag = 3;   // 标签筛选
  int64 page = 4;            // 页码
  int64 page_size = 5;       // 每页数量
}

message SearchResponse {
  repeated Video videos = 1;
  repeated Comic comics = 2;
  repeated Podcast podcasts = 3;
  repeated Article articles = 4;
}

// 点赞请求
message LikeRequest {
  string type = 1; // video,comic,podcast,article,comment
  uint64 target_id = 2; // 目标ID
}

message collectRequest {
  string type = 1;
  uint64 target_id = 2;
}

// 添加评论
message AddCommentRequest {
  string type = 1;
  uint64 target_id = 2;
  uint64 parent_id = 4;
  uint64 reply_comment_id = 5;
  uint64 reply_user_id = 6;
  string content = 7;
}

// 修改评论
message UpdateCommentRequest {
  uint64 id = 1;
  string content = 2;
}

message DeleteCommentRequest {
  uint64 id = 1;
}

message GetCommentsRequest {
  string type = 1;
  uint64 target_id = 2;
  int64 page = 3;
  int64 page_size = 4;
}

// 评论详情
message CommentDetail {
  uint64 id = 1;
  string type = 2;
  uint64 target_id = 3;
  uint64 user_id = 4;
  uint64 parent_id = 5; // 为0 则为根评论
  uint64 reply_comment_id = 6;
  uint64 reply_user_id = 7;
  string content = 8;
  uint64 like_count = 9;
  int64 created_at = 10;
  int64 updated_at = 11;
  bool is_liked = 12; // 用户是否点赞
}

// 评论列表项
message CommentItem {
  CommentDetail comment = 1;  // 评论本身
  repeated CommentDetail child_preview = 2;  // 子评论预览 （默认为前3条）
  int64 child_total = 3;
}

message GetCommentsResponse {
  repeated CommentItem comments = 1;  // 评论列表
  int64 total = 2;  // 总数
}

// 获取内容请求
message GetContentRequest {
  string type = 1;
  uint64 content_id = 2;
}


message Response {
  int64 code = 1 ;
  string message = 2;
  google.protobuf.Any data = 3;
}

service ContentService {
  // 上传文件
  rpc UploadContentStream(stream UploadChunk) returns (Response);

  // 获取访问URL
  rpc GetContentURL(GetContentURLRequest) returns (Response);

  // 添加视频
  rpc AddVideo(AddVideoRequest) returns (Response);

  // 搜索
  rpc Search(SearchRequest) returns (Response);

  // 点赞
  rpc Like(LikeRequest) returns (Response);

  // 收藏
  rpc Collect(collectRequest) returns (Response);

  // 添加评论
  rpc AddComment(AddCommentRequest) returns (Response);

  // 修改评论
  rpc UpdateComment(UpdateCommentRequest) returns (Response);

  // 删除评论
  rpc DeleteComment(DeleteCommentRequest) returns (Response);

  // 获取根评论
  rpc GetComments(GetCommentsRequest) returns (Response);
}
